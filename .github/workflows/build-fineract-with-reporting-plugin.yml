name: Build Fineract With Reporting Plugin

on:
  workflow_dispatch:
    inputs:
      fineract_ref:
        description: "Branch, tag, or SHA for Taalam-Innovations-KE/fineract"
        required: true
        default: "develop"
      plugin_ref:
        description: "Branch, tag, or SHA for Taalam-Innovations-KE/taalam-fincore-reporting-plugin"
        required: true
        default: "develop"
      image_repository:
        description: "Target image repository (for example taalamke/taalam-fineract)"
        required: true
        default: "taalamke/taalam-fineract"
      push_image:
        description: "Push built images to registry"
        required: true
        default: true
        type: boolean
      force_rebuild:
        description: "Force build even when the image tag already exists"
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Resolve build parameters
        id: params
        env:
          INPUT_FINERACT_REF: ${{ inputs.fineract_ref }}
          INPUT_PLUGIN_REF: ${{ inputs.plugin_ref }}
          INPUT_IMAGE_REPOSITORY: ${{ inputs.image_repository }}
          INPUT_PUSH_IMAGE: ${{ inputs.push_image }}
          INPUT_FORCE_REBUILD: ${{ inputs.force_rebuild }}
        run: |
          set -euo pipefail

          fineract_ref="${INPUT_FINERACT_REF:-develop}"
          plugin_ref="${INPUT_PLUGIN_REF:-develop}"
          image_repository="${INPUT_IMAGE_REPOSITORY:-taalamke/taalam-fineract}"
          push_image="${INPUT_PUSH_IMAGE:-true}"
          force_rebuild="${INPUT_FORCE_REBUILD:-false}"

          image_repository="$(echo "${image_repository}" | tr '[:upper:]' '[:lower:]')"
          push_image="$(echo "${push_image}" | tr '[:upper:]' '[:lower:]')"
          force_rebuild="$(echo "${force_rebuild}" | tr '[:upper:]' '[:lower:]')"

          if [ "${push_image}" != "true" ] && [ "${push_image}" != "false" ]; then
            echo "Invalid push_image value: ${push_image}" >&2
            exit 1
          fi
          if [ "${force_rebuild}" != "true" ] && [ "${force_rebuild}" != "false" ]; then
            echo "Invalid force_rebuild value: ${force_rebuild}" >&2
            exit 1
          fi

          first_segment="${image_repository%%/*}"
          if [ "${first_segment}" = "${image_repository}" ]; then
            registry="docker.io"
          elif [[ "${first_segment}" == *.* || "${first_segment}" == *:* || "${first_segment}" == "localhost" ]]; then
            registry="${first_segment}"
          else
            registry="docker.io"
          fi

          if [ "${registry}" != "docker.io" ] && [ "${registry}" != "ghcr.io" ]; then
            echo "Unsupported registry: ${registry}. Use docker.io or ghcr.io." >&2
            exit 1
          fi

          echo "fineract_ref=${fineract_ref}" >> "${GITHUB_OUTPUT}"
          echo "plugin_ref=${plugin_ref}" >> "${GITHUB_OUTPUT}"
          echo "image_repository=${image_repository}" >> "${GITHUB_OUTPUT}"
          echo "push_image=${push_image}" >> "${GITHUB_OUTPUT}"
          echo "force_rebuild=${force_rebuild}" >> "${GITHUB_OUTPUT}"
          echo "registry=${registry}" >> "${GITHUB_OUTPUT}"

      - name: Checkout orchestrator repository
        uses: actions/checkout@v4

      - name: Checkout Fineract source
        uses: actions/checkout@v4
        with:
          repository: Taalam-Innovations-KE/fineract
          ref: ${{ steps.params.outputs.fineract_ref }}
          path: fineract-src
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.CROSS_REPO_TOKEN != '' && secrets.CROSS_REPO_TOKEN || github.token }}

      - name: Checkout reporting plugin source
        uses: actions/checkout@v4
        with:
          repository: Taalam-Innovations-KE/taalam-fincore-reporting-plugin
          ref: ${{ steps.params.outputs.plugin_ref }}
          path: plugin-src
          token: ${{ secrets.CROSS_REPO_TOKEN != '' && secrets.CROSS_REPO_TOKEN || github.token }}

      - name: Compute image tags
        id: tags
        run: |
          set -euo pipefail

          fineract_sha="$(git -C fineract-src rev-parse --short=12 HEAD)"
          plugin_sha="$(git -C plugin-src rev-parse --short=12 HEAD)"

          tag="${fineract_sha}-${plugin_sha}"
          local_image="fineract-with-reporting:${tag}"
          remote_image="${{ steps.params.outputs.image_repository }}:${tag}"
          remote_image_latest="${{ steps.params.outputs.image_repository }}:latest"
          base_image="fineract-base:${fineract_sha}"

          echo "fineract_sha=${fineract_sha}" >> "${GITHUB_OUTPUT}"
          echo "plugin_sha=${plugin_sha}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "base_image=${base_image}" >> "${GITHUB_OUTPUT}"
          echo "local_image=${local_image}" >> "${GITHUB_OUTPUT}"
          echo "remote_image=${remote_image}" >> "${GITHUB_OUTPUT}"
          echo "remote_image_latest=${remote_image_latest}" >> "${GITHUB_OUTPUT}"

      - name: Login to Docker Hub
        if: steps.params.outputs.push_image == 'true' && steps.params.outputs.registry == 'docker.io'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        if: steps.params.outputs.push_image == 'true' && steps.params.outputs.registry == 'ghcr.io'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Check if target image already exists
        id: remote
        if: steps.params.outputs.push_image == 'true' && steps.params.outputs.force_rebuild != 'true'
        run: |
          set -euo pipefail
          if docker manifest inspect "${{ steps.tags.outputs.remote_image }}" >/dev/null 2>&1; then
            echo "exists=true" >> "${GITHUB_OUTPUT}"
          else
            echo "exists=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Set up JDK 21
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Set up Gradle cache
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        uses: gradle/actions/setup-gradle@v4

      - name: Build Fineract base image from source
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        working-directory: fineract-src
        run: |
          set -euo pipefail
          ./gradlew --no-daemon --console=plain :fineract-provider:jibDockerBuild \
            -Djib.to.image=${{ steps.tags.outputs.base_image }} \
            -x test -x cucumber

      - name: Build reporting plugin and dependencies
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        working-directory: plugin-src
        run: |
          set -euo pipefail
          mvn -B -ntp clean package dependency:copy-dependencies \
            -DskipTests \
            -DincludeScope=runtime \
            -DexcludeGroupIds=org.apache.fineract \
            -DoutputDirectory=target/dependency

      - name: Assemble Docker context with plugin and reports
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        id: context
        run: |
          set -euo pipefail
          context_dir="${RUNNER_TEMP}/fineract-reporting-context-${{ steps.tags.outputs.tag }}"
          mkdir -p "${context_dir}/plugin-libs" "${context_dir}/pentahoReports/Postgresql" "${context_dir}/pentahoReports/MariaDB"
          base_artifacts_file="${context_dir}/base-artifacts.txt"

          docker run --rm --entrypoint sh ${{ steps.tags.outputs.base_image }} -c '
            if [ -d /app/libs ]; then
              ls -1 /app/libs/*.jar 2>/dev/null || true
            fi
          ' | xargs -r -n1 basename \
            | sed -E 's/\.jar$//; s/-[0-9].*$//' \
            | sort -u > "${base_artifacts_file}"

          if [ ! -s "${base_artifacts_file}" ]; then
            echo "Failed to detect base image runtime libraries under /app/libs." >&2
            exit 1
          fi

          plugin_jar="$(find plugin-src/target -maxdepth 1 -type f -name 'pentaho-plugin-*.jar' ! -name '*sources*' ! -name '*javadoc*' | head -n 1)"
          if [ -z "${plugin_jar}" ]; then
            echo "Plugin jar not found under plugin-src/target" >&2
            exit 1
          fi

          cp "${plugin_jar}" "${context_dir}/plugin-libs/"
          if compgen -G "plugin-src/target/dependency/*.jar" > /dev/null; then
            while IFS= read -r dep; do
              dep_name="$(basename "${dep}")"
              dep_artifact="$(echo "${dep_name}" | sed -E 's/\.jar$//; s/-[0-9].*$//')"

              if grep -Fxq "${dep_artifact}" "${base_artifacts_file}"; then
                continue
              fi

              if [[ "${dep_name}" == fineract-*.jar || "${dep_name}" == commons-lang3-*.jar || "${dep_name}" == *spring*.jar ]]; then
                continue
              fi

              cp "${dep}" "${context_dir}/plugin-libs/"
            done < <(find plugin-src/target/dependency -maxdepth 1 -type f -name '*.jar' | sort)
          fi

          if compgen -G "${context_dir}/plugin-libs/fineract-*.jar" > /dev/null \
            || compgen -G "${context_dir}/plugin-libs/commons-lang3-*.jar" > /dev/null \
            || compgen -G "${context_dir}/plugin-libs/*spring*.jar" > /dev/null; then
            echo "Found disallowed framework jars in plugin-libs context." >&2
            ls -1 "${context_dir}/plugin-libs" >&2
            exit 1
          fi

          cp -R "plugin-src/pentahoReports/Postgresql/." "${context_dir}/pentahoReports/Postgresql/"
          cp -R "plugin-src/pentahoReports/MariaDB/." "${context_dir}/pentahoReports/MariaDB/"
          cp docker/fineract-with-reporting-plugin.Dockerfile "${context_dir}/Dockerfile"

          echo "context_dir=${context_dir}" >> "${GITHUB_OUTPUT}"

      - name: Build final Fineract image with reporting plugin embedded
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        run: |
          set -euo pipefail
          docker build \
            --build-arg BASE_IMAGE=${{ steps.tags.outputs.base_image }} \
            -t ${{ steps.tags.outputs.local_image }} \
            -f ${{ steps.context.outputs.context_dir }}/Dockerfile \
            ${{ steps.context.outputs.context_dir }}

      - name: Validate embedded plugin and report path
        if: steps.params.outputs.force_rebuild == 'true' || steps.params.outputs.push_image != 'true' || steps.remote.outputs.exists != 'true'
        run: |
          set -euo pipefail
          docker run --rm --entrypoint sh ${{ steps.tags.outputs.local_image }} -c '
            set -e
            ls -1 /app/plugins/*.jar >/dev/null
            if ls -1 /app/plugins/fineract-*.jar >/dev/null 2>&1 \
              || ls -1 /app/plugins/commons-lang3-*.jar >/dev/null 2>&1 \
              || ls -1 /app/plugins/*spring*.jar >/dev/null 2>&1; then
              echo "Disallowed framework jars detected under /app/plugins; this will cause classpath conflicts."
              exit 1
            fi
            test -d /app/pentahoReports/Postgresql
            test -n "$(ls -A /app/pentahoReports/Postgresql)"
            test -d /app/pentahoReports/MariaDB
            test -n "$(ls -A /app/pentahoReports/MariaDB)"
            test "$FINERACT_PENTAHO_REPORTS_PATH" = "/app/pentahoReports/Postgresql"
          '

      - name: Push image
        if: steps.params.outputs.push_image == 'true' && (steps.params.outputs.force_rebuild == 'true' || steps.remote.outputs.exists != 'true')
        run: |
          set -euo pipefail
          docker tag ${{ steps.tags.outputs.local_image }} ${{ steps.tags.outputs.remote_image }}
          docker tag ${{ steps.tags.outputs.local_image }} ${{ steps.tags.outputs.remote_image_latest }}
          docker push ${{ steps.tags.outputs.remote_image }}
          docker push ${{ steps.tags.outputs.remote_image_latest }}

      - name: Build summary
        run: |
          {
            echo "### Fineract Reporting Image Build"
            echo ""
            echo "- Trigger: \`${GITHUB_EVENT_NAME}\`"
            echo "- Fineract ref: \`${{ steps.params.outputs.fineract_ref }}\`"
            echo "- Fineract SHA: \`${{ steps.tags.outputs.fineract_sha }}\`"
            echo "- Plugin ref: \`${{ steps.params.outputs.plugin_ref }}\`"
            echo "- Plugin SHA: \`${{ steps.tags.outputs.plugin_sha }}\`"
            echo "- Image tag: \`${{ steps.tags.outputs.tag }}\`"
            echo "- Embedded report templates: \`Postgresql\` and \`MariaDB\`"
            echo "- Default report path: \`/app/pentahoReports/Postgresql\`"
            echo "- MariaDB override: \`FINERACT_PENTAHO_REPORTS_PATH=/app/pentahoReports/MariaDB\`"
            echo "- Registry: \`${{ steps.params.outputs.registry }}\`"
            echo "- Force rebuild: \`${{ steps.params.outputs.force_rebuild }}\`"
            if [ "${{ steps.params.outputs.push_image }}" = "true" ]; then
              if [ "${{ steps.params.outputs.force_rebuild }}" = "true" ] || [ "${{ steps.remote.outputs.exists }}" != "true" ]; then
                echo "- Published image: \`${{ steps.tags.outputs.remote_image }}\`"
                echo "- Published image alias: \`${{ steps.tags.outputs.remote_image_latest }}\`"
              else
                echo "- Published image: skipped (already exists)"
              fi
            else
              echo "- Published image: skipped (push_image=false)"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
